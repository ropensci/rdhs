<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rdhs client object and internal package design • rdhs</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="rdhs client object and internal package design">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rdhs</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/anemia.html">Anemia prevalence: an `rdhs` example</a>
    </li>
    <li>
      <a href="../articles/boundaries.html">Downloading Shape Files for DHS Surveys</a>
    </li>
    <li>
      <a href="../articles/client.html">rdhs client object and internal package design</a>
    </li>
    <li>
      <a href="../articles/country_codes.html">Country Names and Codes</a>
    </li>
    <li>
      <a href="../articles/geojson.html">Interacting with geojson API returns</a>
    </li>
    <li>
      <a href="../articles/introduction.html">How to use rdhs?</a>
    </li>
    <li>
      <a href="../articles/testing.html">Running test suite locally</a>
    </li>
    <li>
      <a href="../articles/toolkit.html">Toolkit</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/rdhs/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>rdhs client object and internal package
design</h1>
                        <h4 data-toc-skip class="author">OJ Watson, Jeff
Eaton</h4>
            
            <h4 data-toc-skip class="date">2018-09-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rdhs/blob/main/vignettes/client.Rmd" class="external-link"><code>vignettes/client.Rmd</code></a></small>
      <div class="hidden name"><code>client.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The following is a similar vignette - “How to use rdhs?”. However,
this one achieves the same results using the <code>rdhs</code> client
object directly to download datasets etc, rather than using the easier
user interfacing functions. This vignette is included to help
demonstrate how the pacakge internals are working and adds more
information about how the package was designed, which may be useful for
anyone adding extra functionality to <code>rdhs</code> in the
future.</p>
<p>If are not bothered by this then please read the main introductory
vignette.</p>
<hr>
<p><code>rdhs</code> is a package for management and analysis of <a href="https://www.dhsprogram.com/" class="external-link">Demographic and Health Survey
(DHS)</a> data. This includes functionality to:</p>
<ol style="list-style-type: decimal">
<li>Access standard indicator data (i.e. <a href="https://www.statcompiler.com/" class="external-link">DHS STATcompiler</a>) in R via the
<a href="https://api.dhsprogram.com/" class="external-link">DHS API</a>.</li>
<li>Identify surveys and datasets relevant to a particular
analysis.</li>
<li>Download survey datasets from the <a href="https://dhsprogram.com/data/available-datasets.cfm" class="external-link">DHS
website</a>.</li>
<li>Load datasets and associated metadata into R.</li>
<li>Extract variables and combining datasets for pooled multi-survey
analyses.</li>
</ol>
<p>This process is described below and should cover most functionality
that will be needed for working with these datasets.</p>
</div>
<div class="section level2">
<h2 id="installation">0. Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install rdhs from github with <code>devtools</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("ropensci/rdhs")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rdhs/">rdhs</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="access-standard-indicator-data-via-the-api">1. Access standard indicator data via the API<a class="anchor" aria-label="anchor" href="#access-standard-indicator-data-via-the-api"></a>
</h2>
<p>The DHS API has many <em>endpoints</em> that can be accessed using
anyone of <code>dhs_&lt;endpoint&gt;()</code> functions. All exported
functions within <code>rdhs</code> that start <em>dhs_</em> interact
with a different with a different endpoint of the <a href="https://api.dhsprogram.com/" class="external-link">DHS API</a>. Their website gives
great information about the different search terms and filters that can
be used, and we have tried to include all of this within the
documentation of each function.</p>
<p>One of those endpoints, <code><a href="../reference/dhs_data.html">dhs_data()</a></code>, interacts with the
the published set of standard health indicator data calculated by the
DHS. This endpoint allows use to retrieve a set of health indicators
that have been sample weighted to give country, subnational estimates
that can be further refined by education and wealth brackets. To do this
we use the <code><a href="../reference/dhs_data.html">dhs_data()</a></code> endpoint, which we can then either
search for specific indicators, or by querying for indicators that have
been tagged within specific areas.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## what are the indicators</span></span>
<span><span class="va">indicators</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_indicators.html">dhs_indicators</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">indicators</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                                                                           Definition</span></span>
<span><span class="co">## 1 Age-specific fertility rate for the three years preceding the survey for age group 10-14 expressed per 1,000 women</span></span>
<span><span class="co">##   NumberScale IndicatorType MeasurementType IsQuickStat  ShortName</span></span>
<span><span class="co">## 1           0             I            Rate           0 ASFR 10-14</span></span>
<span><span class="co">##     IndicatorId    Level1 IndicatorTotalId          Level2 Level3</span></span>
<span><span class="co">## 1 FE_FRTR_W_A10 Fertility                  Fertility rates  Women</span></span>
<span><span class="co">##        SDRID IndicatorOldId TagIds DenominatorWeightedId</span></span>
<span><span class="co">## 1 FEFRTRWA10                                            </span></span>
<span><span class="co">##                                Label IndicatorOrder</span></span>
<span><span class="co">## 1 Age specific fertility rate: 10-14       11763005</span></span>
<span><span class="co">##                                                                     Denominator</span></span>
<span><span class="co">## 1 Per thousand women years exposed in the period 1-36 months prior to interview</span></span>
<span><span class="co">##   QuickStatOrder IndicatorSpecial1Id DenominatorUnweightedId</span></span>
<span><span class="co">## 1                                                           </span></span>
<span><span class="co">##   IndicatorSpecial2Id</span></span>
<span><span class="co">## 1</span></span></code></pre>
<p>Each call to a DHS endpoint returns a <code>data.frame</code> by
default with all the results available by default.</p>
<p>The DHS has a unique <em>IndicatorId</em> for each of the statistics
it calculates. The definition and specific string for each indicator is
included within the <em>IndicatorId</em> and <em>Definition</em>
variable:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># grab the first 5 alphabetically</span></span>
<span><span class="va">indicators</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">indicators</span><span class="op">$</span><span class="va">IndicatorId</span><span class="op">)</span>,<span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndicatorId"</span>, <span class="st">"Definition"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##        IndicatorId</span></span>
<span><span class="co">## 2031 AH_CIGA_M_UNW</span></span>
<span><span class="co">## 2026 AH_CIGA_W_10P</span></span>
<span><span class="co">## 2023 AH_CIGA_W_12C</span></span>
<span><span class="co">## 2024 AH_CIGA_W_35C</span></span>
<span><span class="co">## 2025 AH_CIGA_W_69C</span></span>
<span><span class="co">##                                                               Definition</span></span>
<span><span class="co">## 2031                     Number of men who smoke cigarettes (unweighted)</span></span>
<span><span class="co">## 2026 Percentage of women who smoked 10+ cigarettes in preceding 24 hours</span></span>
<span><span class="co">## 2023 Percentage of women who smoked 1-2 cigarettes in preceding 24 hours</span></span>
<span><span class="co">## 2024 Percentage of women who smoked 3-5 cigarettes in preceding 24 hours</span></span>
<span><span class="co">## 2025 Percentage of women who smoked 6-9 cigarettes in preceding 24 hours</span></span></code></pre>
<p>Since there are quite a lot of indicators, it might be easier to
first query by tags. The DHS tags their indicators by what areas of
demography and health they relate to, e.g. anaemia, literacy, malaria
parasitaemia are all specific tags. First let’s look at what the tags
are, by interacting with the <code><a href="../reference/dhs_tags.html">dhs_tags()</a></code> endpoint, before
grabbing data that related to malaria parasitaemia in the DRC and
Tanzania since 2010:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># What are the tags</span></span>
<span><span class="va">tags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_tags.html">dhs_tags</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's say we want to view the tags that relate to malaria</span></span>
<span><span class="va">tags</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Malaria"</span>, <span class="va">tags</span><span class="op">$</span><span class="va">TagName</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    TagType                   TagName TagID TagOrder</span></span>
<span><span class="co">## 31       0       Malaria Parasitemia    36      540</span></span>
<span><span class="co">## 43       2 Select Malaria Indicators    79     1000</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and now let's then grab this data by specifying the countryIds and the survey year starts</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_data.html">dhs_data</a></span><span class="op">(</span>tagIds <span class="op">=</span> <span class="fl">36</span>,countryIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD"</span>,<span class="st">"TZ"</span><span class="op">)</span>,breakdown<span class="op">=</span><span class="st">"subnational"</span>,surveyYearStart <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   DataId                           Indicator  SurveyId IsPreferred Value</span></span>
<span><span class="co">## 1 941297 Malaria prevalence according to RDT CD2013DHS           1  17.1</span></span>
<span><span class="co">##        SDRID Precision        RegionId SurveyYearLabel SurveyType</span></span>
<span><span class="co">## 1 MLPMALCRDT         1 CDDHS2013503010         2013-14        DHS</span></span>
<span><span class="co">##   SurveyYear IndicatorOrder DHS_CountryCode CILow</span></span>
<span><span class="co">## 1       2013      125136010              CD      </span></span>
<span><span class="co">##                 CountryName IndicatorType CharacteristicId</span></span>
<span><span class="co">## 1 Congo Democratic Republic             I           503010</span></span>
<span><span class="co">##   CharacteristicCategory   IndicatorId CharacteristicOrder</span></span>
<span><span class="co">## 1                 Region ML_PMAL_C_RDT             1503010</span></span>
<span><span class="co">##   CharacteristicLabel ByVariableLabel DenominatorUnweighted</span></span>
<span><span class="co">## 1            Kinshasa                                   406</span></span>
<span><span class="co">##   DenominatorWeighted CIHigh IsTotal ByVariableId</span></span>
<span><span class="co">## 1                 532              0            0</span></span></code></pre>
<p>Depending on your analysis this maybe more than enough detail. It is
also worth mentioning that this data can also be accessed via <a href="https://www.statcompiler.com/" class="external-link">DHS STATcompiler</a> if you prefer
a click and collect version. However, hopefully one can see that
selecting a lot of different indicators for multiple countries and
breakdowns should be a lot easier using the <code>rdhs</code> API
interaction. For example we can very quickly find out the trends in
antimalarial use in Africa, and see if perhaps antimalarial prescription
has decreased after RDTs were introduced (assumed 2010).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make an api request</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_data.html">dhs_data</a></span><span class="op">(</span>indicatorIds <span class="op">=</span> <span class="st">"ML_FEVT_C_AML"</span>, surveyYearStart <span class="op">=</span> <span class="fl">2010</span>,breakdown <span class="op">=</span> <span class="st">"subnational"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter it to 12 countries for space</span></span>
<span><span class="va">countries</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Angola"</span>,<span class="st">"Ghana"</span>,<span class="st">"Kenya"</span>,<span class="st">"Liberia"</span>,</span>
<span>                <span class="st">"Madagascar"</span>,<span class="st">"Mali"</span>,<span class="st">"Malawi"</span>,<span class="st">"Nigeria"</span>,</span>
<span>                <span class="st">"Rwanda"</span>,<span class="st">"Sierra Leone"</span>,<span class="st">"Senegal"</span>,<span class="st">"Tanzania"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and plot the results</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">resp</span><span class="op">[</span><span class="va">resp</span><span class="op">$</span><span class="va">CountryName</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">countries</span>,<span class="op">]</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">SurveyYear</span>,y<span class="op">=</span><span class="va">Value</span>,colour<span class="op">=</span><span class="va">CountryName</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"glm"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="va">resp</span><span class="op">$</span><span class="va">Indicator</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">CountryName</span>,ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> </span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/ropensci/rdhs/development/vignettes/client_files/figure-html/unnamed-chunk-1-1.png" style="display: block; margin: auto;"></p>
<p>If we incorrectly entered a filter query (very possible),
<code>rdhs</code> will let us know our request was invalid:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make an api request</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_data.html">dhs_data</a></span><span class="op">(</span>indicatorIds<span class="op">=</span><span class="st">"ML_FEVT_C_AMasfafasfL"</span>,</span>
<span>                 surveyYearStart<span class="op">=</span><span class="fl">202231231306</span>,</span>
<span>                 breakdown<span class="op">=</span><span class="st">"subParTyping"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in handle_api_response(resp, TRUE): </span></span>
<span><span class="co">##    -&gt; DHS API Request Failed [500] </span></span>
<span><span class="co">##    -&gt; Error Type: dhs_internal_server_error</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="identify-surveys-relevant-for-further-analysis">2. Identify surveys relevant for further analysis<a class="anchor" aria-label="anchor" href="#identify-surveys-relevant-for-further-analysis"></a>
</h2>
<p>You may, however, wish to do more nuanced analysis than the API
allows. The following 4 section detail a very basic example of how to
quickly identify, download and extract datasets you are interested
in.</p>
<p>Let’s say we want to get all the survey data from the Democratic
Republic of Congo and Tanzania in the last 5 years (since 2013), which
covers the use of rapid diagnostic tests (RDTs) for malaria. To begin
we’ll interact with the DHS API to identify our datasets.</p>
<p>To start our extraction we’ll query the
<em>surveyCharacteristics</em> endpoint using
<code>dhs_surveyCharacteristics()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## make a call with no arguments</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_survey_characteristics.html">dhs_survey_characteristics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Malaria"</span>, <span class="va">sc</span><span class="op">$</span><span class="va">SurveyCharacteristicName</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    SurveyCharacteristicID SurveyCharacteristicName</span></span>
<span><span class="co">## 57                     96            Malaria - DBS</span></span>
<span><span class="co">## 58                     90     Malaria - Microscopy</span></span>
<span><span class="co">## 59                     89            Malaria - RDT</span></span>
<span><span class="co">## 60                     57          Malaria module </span></span>
<span><span class="co">## 61                      8 Malaria/bednet questions</span></span></code></pre>
<p>There are 87 different survey characteristics, with one specific
survey characteristic for Malaria RDTs. We’ll use this to then find the
surveys that include this characteristic. We can also at this point
filter for our desired countries and years. The DHS API allows for
countries to be filtered using by their <em>countryIds</em>, which is
one of the arguments in <code><a href="../reference/dhs_surveys.html">dhs_surveys()</a></code>. To have a look at
what each countries countryId is we can use another of the API endpoints
first:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## what are the countryIds</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_countries.html">dhs_countries</a></span><span class="op">(</span>returnFields<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CountryName"</span>, <span class="st">"DHS_CountryCode"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    91 obs. of  2 variables:</span></span>
<span><span class="co">##  $ DHS_CountryCode: chr  "AF" "AL" "AO" "AM" ...</span></span>
<span><span class="co">##  $ CountryName    : chr  "Afghanistan" "Albania" "Angola" "Armenia" ...</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lets find all the surveys that fit our search criteria</span></span>
<span><span class="va">survs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_surveys.html">dhs_surveys</a></span><span class="op">(</span>surveyCharacteristicIds <span class="op">=</span> <span class="fl">89</span>,countryIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD"</span>,<span class="st">"TZ"</span><span class="op">)</span>,surveyYearStart <span class="op">=</span> <span class="fl">2013</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and lastly use this to find the datasets we will want to download and let's download the flat files (.dat) datasets (have a look in the dhs_datasets documentation for all argument options, and fileformat abbreviations etc.)</span></span>
<span><span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_datasets.html">dhs_datasets</a></span><span class="op">(</span>surveyIds <span class="op">=</span> <span class="va">survs</span><span class="op">$</span><span class="va">SurveyId</span>, fileFormat <span class="op">=</span> <span class="st">"flat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    19 obs. of  13 variables:</span></span>
<span><span class="co">##  $ FileFormat          : chr  "Flat ASCII data (.dat)" "Flat ASCII data (.dat)" "Flat ASCII data (.dat)" "Flat ASCII data (.dat)" ...</span></span>
<span><span class="co">##  $ FileSize            : int  198561 7030083 3226262 8028957 11426382 4794941 1569680 6595349 63022 996906 ...</span></span>
<span><span class="co">##  $ DatasetType         : chr  "HIV Datasets" "Survey Datasets" "Survey Datasets" "Survey Datasets" ...</span></span>
<span><span class="co">##  $ SurveyNum           : int  421 421 421 421 421 421 421 421 421 421 ...</span></span>
<span><span class="co">##  $ SurveyId            : chr  "CD2013DHS" "CD2013DHS" "CD2013DHS" "CD2013DHS" ...</span></span>
<span><span class="co">##  $ FileType            : chr  "HIV Test Results Recode" "Births Recode" "Couples' Recode" "Household Recode" ...</span></span>
<span><span class="co">##  $ FileDateLastModified: chr  "November, 14 2014 12:48:34" "November, 17 2014 15:42:54" "November, 17 2014 15:43:04" "September, 19 2016 09:57:20" ...</span></span>
<span><span class="co">##  $ SurveyYearLabel     : chr  "2013-14" "2013-14" "2013-14" "2013-14" ...</span></span>
<span><span class="co">##  $ SurveyType          : chr  "DHS" "DHS" "DHS" "DHS" ...</span></span>
<span><span class="co">##  $ SurveyYear          : int  2013 2013 2013 2013 2013 2013 2013 2013 2013 2013 ...</span></span>
<span><span class="co">##  $ DHS_CountryCode     : chr  "CD" "CD" "CD" "CD" ...</span></span>
<span><span class="co">##  $ FileName            : chr  "CDAR61FL.ZIP" "CDBR61FL.ZIP" "CDCR61FL.ZIP" "CDHR61FL.ZIP" ...</span></span>
<span><span class="co">##  $ CountryName         : chr  "Congo Democratic Republic" "Congo Democratic Republic" "Congo Democratic Republic" "Congo Democratic Republic" ...</span></span></code></pre>
<p>Lastly, we recommended to download either the spss (.sav),
<code>fileFormat = "SV"</code>, or the flat file (.dat),
<code>fileFormat = "FL"</code> datasets. The flat is quicker, but there
are still one or two datasets that don’t read correctly, whereas the
.sav files are slower to read in but so far no datasets have been found
that don’t read in correctly.</p>
<p>We can now use this to download our datasets for further
analysis.</p>
</div>
<div class="section level2">
<h2 id="download-survey-datasets">3. Download survey datasets<a class="anchor" aria-label="anchor" href="#download-survey-datasets"></a>
</h2>
<p>We can now go ahead and download our datasets. To do this we need to
first create a <code>client</code>. The client is an R6 class (similar
to R’s built in reference classes and make caching survey and API
queries more reproducible) and will be used to log in to your DHS
account, download datasets for you, and help query those datasets for
the question you are interested in. The client will also cache all of
these processes, which really helps increase the reproducibility of your
analysis.</p>
<p>In order to set up our credentials we use the function
<code><a href="../reference/set_rdhs_config.html">set_rdhs_config()</a></code>. This will require providing as arguments
your <code>email</code> and <code>project</code> for which you want to
download datasets from. You will then be prompted for your password.</p>
<p>You can also specify a directory for datasets and API calls to be
cached to using <code>cache_path</code>. If you do not provide an
argument for <code>cache_path</code> you will be prompted to provide
permission to <code>rdhs</code> to save your datasets and API calls
within your user cache directory for your operating system. This is to
comply with CRAN’s requests for permission to be granted before writing
to system files. If you do not grant permission, these will be written
within your R temporary directory (as we saw above when we first used
one of the functions to query the API). Similarly if you do not also
provide an argument for <code>config_path</code>, this will be saved
within your temp directory unless permission is granted. Your config
files will always be called “rdhs.json”, so that <code>rdhs</code> can
find them easily.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create a client</span></span>
<span><span class="co">## set up your credentials</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_rdhs_config.html">set_rdhs_config</a></span><span class="op">(</span>email <span class="op">=</span> <span class="st">"rdhs.tester@gmail.com"</span>,</span>
<span>                project <span class="op">=</span> <span class="st">"Testing Malaria Investigations"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/client_dhs.html">client_dhs</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span><span class="va">client</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;client_dhs&gt;</span></span>
<span><span class="co">##   Public:</span></span>
<span><span class="co">##     available_datasets: function (clear_cache_first = FALSE) </span></span>
<span><span class="co">##     clear_namespace: function (namespace) </span></span>
<span><span class="co">##     dhs_api_request: function (api_endpoint, query = list(), api_key = private$api_key, </span></span>
<span><span class="co">##     extract: function (questions, add_geo = FALSE) </span></span>
<span><span class="co">##     get_cache_date: function () </span></span>
<span><span class="co">##     get_config: function () </span></span>
<span><span class="co">##     get_datasets: function (dataset_filenames, download_option = "rds", reformat = FALSE, </span></span>
<span><span class="co">##     get_downloaded_datasets: function () </span></span>
<span><span class="co">##     get_root: function () </span></span>
<span><span class="co">##     get_variable_labels: function (dataset_filenames = NULL, dataset_paths = NULL, rm_na = FALSE) </span></span>
<span><span class="co">##     initialize: function (config, api_key = NULL, root = rappdirs_rdhs()) </span></span>
<span><span class="co">##     save_client: function () </span></span>
<span><span class="co">##     set_cache_date: function (date) </span></span>
<span><span class="co">##     survey_questions: function (dataset_filenames, search_terms = NULL, essential_terms = NULL, </span></span>
<span><span class="co">##     survey_variables: function (dataset_filenames, variables, essential_variables = NULL, </span></span>
<span><span class="co">##   Private:</span></span>
<span><span class="co">##     api_endpoints: data indicators countries surveys surveycharacteristics  ...</span></span>
<span><span class="co">##     api_key: ********</span></span>
<span><span class="co">##     cache_date: 2018-09-24 16:36:45</span></span>
<span><span class="co">##     check_available_datasets: function (filenames) </span></span>
<span><span class="co">##     config: rdhs_config</span></span>
<span><span class="co">##     na_s: ^na -|^na-|.*-na$|.* - na$| \{NA\}$|.* NA$|.*NA$</span></span>
<span><span class="co">##     package_version: package_version, numeric_version</span></span>
<span><span class="co">##     root: C:\Users\Oliver\AppData\Local\Oliver\rdhs\Cache</span></span>
<span><span class="co">##     storr: storr, R6</span></span>
<span><span class="co">##     url: https://api.dhsprogram.com/rest/dhs/</span></span>
<span><span class="co">##     user_declared_root: NULL</span></span></code></pre>
<p>Before we use our client to download our datasets, it is worth
mentioning that the client can be passed as an argument to any of the
API functions we have just seen. This will then cache the results for
you, so that if you are working remotely or without a good internet
connection you can still return your previous API requests. This is what
is happening behind the scenes anyway, as <code>rdhs</code> will create
a client for you when you call an API function (if one does not already
exist).</p>
<hr>
<p>Now back to our dataset downloads. If we have a look back at our
datasets object, we’ll see there are 19 datasets listed. However, not
all of them will be relevant to our malaria RDT questions. One approach
is to head to the DHS website and have a look at the <a href="https://dhsprogram.com/publications/publication-dhsg4-dhs-questionnaires-and-manuals.cfm" class="external-link">DHS
Recodes</a>, and look at the recodes that relate to the surveys. The
other alternative is to download all the surveys and then query the
variables within them. This is what we’ll demonstrate here as it also
demonstrates more of the package’s functionality:</p>
<p>So first we will download all these datasets:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># download datasets</span></span>
<span><span class="va">downloads</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">get_datasets</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span><span class="op">)</span></span></code></pre></div>
<p>The function returns a list with a file path to where the downloaded
datasets have been saved to. By default the files will download quietly,
i.e. no progress is shown. However, if you want to see the progress then
you can control this by setting this in your config using the
<code>verbose_download</code> argument.</p>
</div>
<div class="section level2">
<h2 id="load-datasets-and-associated-metadata-into-r-">4. Load datasets and associated metadata into R.<a class="anchor" aria-label="anchor" href="#load-datasets-and-associated-metadata-into-r-"></a>
</h2>
<p>We can now examine what it is we have actually downloaded, by reading
in one of these datasets:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read in our dataset</span></span>
<span><span class="va">cdpr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">downloads</span><span class="op">$</span><span class="va">CDPR61FL</span><span class="op">)</span></span></code></pre></div>
<p>The dataset returned here contains all the survey questions within
the dataset, and what their survey variables are:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># let's look at the variable_names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_variable_labels.html">get_variable_labels</a></span><span class="op">(</span><span class="va">cdpr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   variable                                                  description</span></span>
<span><span class="co">## 1     hhid                                          Case Identification</span></span>
<span><span class="co">## 2    hvidx                                                  Line number</span></span>
<span><span class="co">## 3    hv000                                       Country code and phase</span></span>
<span><span class="co">## 4    hv001                                               Cluster number</span></span>
<span><span class="co">## 5    hv002                                             Household number</span></span>
<span><span class="co">## 6    hv003 Respondent's line number (answering Household questionnaire)</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and then the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">cdpr</span><span class="op">$</span><span class="va">hv024</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "labelled"</span></span></code></pre>
<p>This is the default behaviour for the client function
<code>get_datasets</code> - it will download the datasets for you, and
then by default save them in your client’s root directory and then unzip
them and read them in for you, and save the resultant data.frame as a
.rds object within the client’s root directory. You can control this
behaviour using the <code>download_option</code> argument as such:</p>
<ul>
<li>
<code>client$get_datasets(download_option = "zip")</code> - Just the
downloaded zip will be saved</li>
<li>
<code>client$get_datasets(download_option = "rds")</code> - Just the
read in rds will be saved</li>
<li>
<code>client$get_datasets(download_option = "both")</code> - The zip
is downloaded and saved as well as the read in rds</li>
</ul>
<p>The other main reason for reading the dataset in straight away as the
default option is that the created table of all the survey variables and
their definitions is cached then and there, which then allows us to
quickly query for particular search terms or survey variables:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rapid diagnostic test search</span></span>
<span><span class="va">questions</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">survey_questions</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>, search_terms <span class="op">=</span> <span class="st">"malaria rapid test"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">questions</span><span class="op">$</span><span class="va">dataset_filename</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## CDHR61FL CDPR61FL TZHR7AFL TZPR7AFL </span></span>
<span><span class="co">##       24        1       48        1</span></span></code></pre>
<p>What we see from the questions is that the question “Result of
malaria rapid test” appears in a few different datasets. This is because
the household member recode datasets (CDPR61SV, TZPR7HSV) stores
information about the children in a household, with one row per child,
whereas the household recode (CDHR61SV, TZHR7HSV) stores information
about the household, and thus flattens the information from each child
into different subvariables (hml35$01/02 etc). As such it is easier to
extract this information from the household member recodes.</p>
</div>
<div class="section level2">
<h2 id="extract-variables-and-combining-datasets-for-pooled-multi-survey-analyses-">5. Extract variables and combining datasets for pooled multi-survey
analyses.<a class="anchor" aria-label="anchor" href="#extract-variables-and-combining-datasets-for-pooled-multi-survey-analyses-"></a>
</h2>
<p>To extract our data we pass our questions object to the client
function <code>extract</code>, which will create a list with each
dataset and its extracted data as a <code>data.frame</code>. We also
have the option to add any geographic data available, which will
download the geographic data files for you and add this data to you
resultant extract:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># let's just use the PR files thus</span></span>
<span><span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_datasets.html">dhs_datasets</a></span><span class="op">(</span>surveyIds <span class="op">=</span> <span class="va">survs</span><span class="op">$</span><span class="va">SurveyId</span>, fileFormat <span class="op">=</span> <span class="st">"FL"</span>, fileType <span class="op">=</span> <span class="st">"PR"</span><span class="op">)</span></span>
<span><span class="va">downloads</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">get_datasets</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and grab the questions from this again along with also questions detailing the province</span></span>
<span><span class="va">questions</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">survey_questions</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>, search_terms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"malaria rapid test"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and now extract the data</span></span>
<span><span class="va">extract</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="va">questions</span>, add_geo <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># what does our extract look like</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">extract</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 2</span></span>
<span><span class="co">##  $ CDPR61FL:Classes 'dhs_dataset' and 'data.frame':  95949 obs. of  2 variables:</span></span>
<span><span class="co">##   ..$ hml35   : 'labelled' int [1:95949] NA NA NA NA NA NA NA 1 0 NA ...</span></span>
<span><span class="co">##   .. ..- attr(*, "label")= chr "Result of malaria rapid test"</span></span>
<span><span class="co">##   .. ..- attr(*, "labels")= Named int [1:3] 0 1 9</span></span>
<span><span class="co">##   .. .. ..- attr(*, "names")= chr [1:3] "negative" "positive" "missing"</span></span>
<span><span class="co">##   ..$ SurveyId: chr [1:95949] "CD2013DHS" "CD2013DHS" "CD2013DHS" "CD2013DHS" ...</span></span>
<span><span class="co">##  $ TZPR7AFL:Classes 'dhs_dataset' and 'data.frame':  64880 obs. of  2 variables:</span></span>
<span><span class="co">##   ..$ hml35   : 'labelled' int [1:64880] NA NA NA NA NA NA NA 0 NA NA ...</span></span>
<span><span class="co">##   .. ..- attr(*, "label")= chr "Result of malaria rapid test"</span></span>
<span><span class="co">##   .. ..- attr(*, "labels")= Named int [1:3] 0 1 9</span></span>
<span><span class="co">##   .. .. ..- attr(*, "names")= chr [1:3] "negative" "positive" "missing"</span></span>
<span><span class="co">##   ..$ SurveyId: chr [1:64880] "TZ2015DHS" "TZ2015DHS" "TZ2015DHS" "TZ2015DHS" ...</span></span></code></pre>
<p>The resultant extract is a list, with a new element for each
different dataset that you have extracted. The responses from the
dataset are by default stored as a <em>labelled</em> class from the <a href="https://github.com/tidyverse/haven" class="external-link">haven package</a>. This class
preserves the original semantics and can easily be coerced to factors
with <code><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">haven::as_factor()</a></code>. Special missing values are also
preserved. For more info on the <em>labelled</em> class have a look at
their github.</p>
<p>We can also query our datasets for the survey question variables. In
the example above the survey question was <em>Result of malaria rapid
test</em> and the variable was <em>hml35</em>. So if you knew the survey
variables that you wanted (either by looking at the Recode file or by
looking through the <em>variable_names</em> included in the datasets)
then we could search against these. So let’s grab the regions using
<em>hv024</em> using the client function
<code>survey_variables()</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and grab the questions from this now utilising the survey variables</span></span>
<span><span class="va">questions</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">survey_variables</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hv024"</span>,<span class="st">"hml35"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and now extract the data</span></span>
<span><span class="va">extract2</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="va">questions</span>, add_geo <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># quick check </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">extract2</span><span class="op">$</span><span class="va">CDPR61FL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   hv024 hml35  SurveyId</span></span>
<span><span class="co">## 1     4    NA CD2013DHS</span></span>
<span><span class="co">## 2     4    NA CD2013DHS</span></span>
<span><span class="co">## 3     4    NA CD2013DHS</span></span>
<span><span class="co">## 4     4    NA CD2013DHS</span></span>
<span><span class="co">## 5     4    NA CD2013DHS</span></span>
<span><span class="co">## 6     4    NA CD2013DHS</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">extract2</span><span class="op">$</span><span class="va">TZPR7HFL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># and just to prove that hml35 did actually read in okay (there are just lots of NA)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">extract2</span><span class="op">$</span><span class="va">CDPR61FL</span><span class="op">$</span><span class="va">hml35</span>,useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     0     1     9  &lt;NA&gt; </span></span>
<span><span class="co">##  5260  2959     8 87722</span></span></code></pre>
<p>We can now combine our two dataframes for further analysis using the
<code>rdhs</code> package function <code><a href="../reference/rbind_labelled.html">rbind_labelled()</a></code>. This
function works specifically with our lists of labelled data.frames:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first let's bind our first extraction, without the hv024</span></span>
<span><span class="va">extract_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extract</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">extract_bound</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            hml35  SurveyId  DATASET</span></span>
<span><span class="co">## CDPR61FL.1    NA CD2013DHS CDPR61FL</span></span>
<span><span class="co">## CDPR61FL.2    NA CD2013DHS CDPR61FL</span></span>
<span><span class="co">## CDPR61FL.3    NA CD2013DHS CDPR61FL</span></span>
<span><span class="co">## CDPR61FL.4    NA CD2013DHS CDPR61FL</span></span>
<span><span class="co">## CDPR61FL.5    NA CD2013DHS CDPR61FL</span></span>
<span><span class="co">## CDPR61FL.6    NA CD2013DHS CDPR61FL</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now let's try our second extraction</span></span>
<span><span class="va">extract2_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extract2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in rbind_labelled(extract2): Some variables have non-matching value labels: hv024.</span></span>
<span><span class="co">## Inheriting labels from first data frame with labels.</span></span></code></pre>
<p>This hasn’t quite done what we might want in the second instance. The
<em>hv024</em> variable stores the regions for these 2 countries, which
will not be the same and thus the labels will be different between the
two of them. Without specifying any additional arguments
<code><a href="../reference/rbind_labelled.html">rbind_labelled()</a></code> will simply use the first data.frames
labelling as the default, which will mean that some of the Tanzanian
provinces will have been encoded as DRC provinces - not good! (This is a
similar problem in nature to say trying to add new character strings to
a factored data.frame).</p>
<p>There are a few work arounds. Firstly, we can specify a
<em>labels</em> argument to the function which will detail how we should
handle different variables. <em>labels</em> is a names list that
specifies how to handle each variable. If we simply want to keep all the
labels then we us the string “concatenate”:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lets try concatenating the hv024</span></span>
<span><span class="va">better_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extract2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"hv024"</span><span class="op">=</span><span class="st">"concatenate"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">better_bound</span><span class="op">$</span><span class="va">hv024</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;Labelled integer&gt;</span></span>
<span><span class="co">## [1] 6 6 6 6 6 6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Labels:</span></span>
<span><span class="co">##  value            label</span></span>
<span><span class="co">##      1           arusha</span></span>
<span><span class="co">##      2         bandundu</span></span>
<span><span class="co">##      3        bas-congo</span></span>
<span><span class="co">##      4    dar es salaam</span></span>
<span><span class="co">##      5           dodoma</span></span>
<span><span class="co">##      6         equateur</span></span>
<span><span class="co">##      7            geita</span></span>
<span><span class="co">##      8           iringa</span></span>
<span><span class="co">##      9           kagera</span></span>
<span><span class="co">##     10 kasai-occidental</span></span>
<span><span class="co">##     11   kasai-oriental</span></span>
<span><span class="co">##     12  kaskazini pemba</span></span>
<span><span class="co">##     13 kaskazini unguja</span></span>
<span><span class="co">##     14          katanga</span></span>
<span><span class="co">##     15           katavi</span></span>
<span><span class="co">##     16           kigoma</span></span>
<span><span class="co">##     17      kilimanjaro</span></span>
<span><span class="co">##     18         kinshasa</span></span>
<span><span class="co">##     19     kusini pemba</span></span>
<span><span class="co">##     20    kusini unguja</span></span>
<span><span class="co">##     21            lindi</span></span>
<span><span class="co">##     22          maniema</span></span>
<span><span class="co">##     23          manyara</span></span>
<span><span class="co">##     24             mara</span></span>
<span><span class="co">##     25            mbeya</span></span>
<span><span class="co">##     26  mjini magharibi</span></span>
<span><span class="co">##     27         morogoro</span></span>
<span><span class="co">##     28           mtwara</span></span>
<span><span class="co">##     29           mwanza</span></span>
<span><span class="co">##     30           njombe</span></span>
<span><span class="co">##     31        nord-kivu</span></span>
<span><span class="co">##     32        orientale</span></span>
<span><span class="co">##     33            pwani</span></span>
<span><span class="co">##     34            rukwa</span></span>
<span><span class="co">##     35           ruvuma</span></span>
<span><span class="co">##     36        shinyanga</span></span>
<span><span class="co">##     37           simiyu</span></span>
<span><span class="co">##     38          singida</span></span>
<span><span class="co">##     39         sud-kivu</span></span>
<span><span class="co">##     40           tabora</span></span>
<span><span class="co">##     41            tanga</span></span></code></pre>
<p>We could also specify new labels for a variable. For example, imagine
the two datasets encoded their RDT responses differently, with the first
one as <code>c("No","Yes")</code> and the other as
<code>c("Negative","Positive")</code>. These would be for our purposes
the same response, and so we could either leave it and all our results
would use the <code>c("No","Yes")</code> labelling. But we may want to
use the latter as it’s more informative/correct, or we may want to be
crystal clear and use <code>c("NegativeTest","PositiveTest")</code>. we
can do that like this:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lets try concatenating the hv024 and providing new labels</span></span>
<span><span class="va">better_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extract2</span>,</span>
<span>                               labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"hv024"</span><span class="op">=</span><span class="st">"concatenate"</span>,</span>
<span>                                             <span class="st">"hml35"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NegativeTest"</span><span class="op">=</span><span class="fl">0</span>, <span class="st">"PositiveTest"</span><span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and our new label</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">better_bound</span><span class="op">$</span><span class="va">hml35</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;Labelled integer&gt;</span></span>
<span><span class="co">## [1] NA NA NA NA NA NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Labels:</span></span>
<span><span class="co">##  value        label</span></span>
<span><span class="co">##      0 NegativeTest</span></span>
<span><span class="co">##      1 PositiveTest</span></span></code></pre>
<p>The other option is to not use the labelled class at all. We can
control this when we download our datasets, using the argument
<code>reformat=TRUE</code>. This will ensure that no factors or labels
are used and it is just the raw data. When this option is set the object
returned by <code>client$get_datasets()</code> no longer has any
labelled classes or factors. However, we can still recover the variable
table for a dataset using <code><a href="../reference/get_variable_labels.html">get_variable_labels()</a></code>, which will
take any dataset output by <code><a href="../reference/get_datasets.html">get_datasets()</a></code> and return a
data.frame describing the survey question variables and definitions.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># download the datasets with the reformat arguments</span></span>
<span><span class="va">downloads</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">get_datasets</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>, reformat<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># grab the questions but specifying the reformat argument</span></span>
<span><span class="va">questions</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">survey_variables</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hv024"</span>, <span class="st">"hml35"</span><span class="op">)</span>,</span>
<span>                                     reformat<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and now extract the data</span></span>
<span><span class="va">extract3</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="va">questions</span>, add_geo <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># group our results</span></span>
<span><span class="va">bound_no_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extract3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># what does our hv024 look like now</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">bound_no_labels</span><span class="op">$</span><span class="va">hv024</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "character"</span></span></code></pre>
<p>The <em>hv024</em> column is now just characters, which is possibly
the best option depending on your downstream analysis/preferences. It’s
for this reason that the geographic data that is added is never turned
into factors or labels.</p>
<p>Lastly, we can now use our extract dataset to carry out some
regression analysis, to investigate the relationship between malaria
prevalence and the quality of wall materials. To do this we will need to
first grab the sample weights and stratification from the surveys, along
with the extra variables and we will then check the RDT prevalence
calculated using the raw data versus the API:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># grab the additional variable hv023 and hv024 which have the strata and weights respectively</span></span>
<span><span class="va">questions</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">survey_variables</span><span class="op">(</span><span class="va">datasets</span><span class="op">$</span><span class="va">FileName</span>,variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hv005"</span>,<span class="st">"hv021"</span>,<span class="st">"hv022"</span>,<span class="st">"hv023"</span>,<span class="st">"hv024"</span>,</span>
<span>                                                              <span class="st">"hv025"</span>,<span class="st">"hv214"</span>,<span class="st">"hml20"</span>, <span class="st">"hc1"</span>,<span class="st">"hml35"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">extraction</span> <span class="op">&lt;-</span> <span class="va">client</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="va">questions</span>,<span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now concatenate the provinces as before and remove missing responses</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rbind_labelled.html">rbind_labelled</a></span><span class="op">(</span><span class="va">extraction</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"hv024"</span><span class="op">=</span><span class="st">"concatenate"</span>,<span class="st">"hv214"</span><span class="op">=</span><span class="st">"concatenate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">hml35</span><span class="op">==</span><span class="fl">9</span><span class="op">)</span>,<span class="op">]</span> <span class="co"># remove missing responses</span></span>
<span></span>
<span><span class="co"># and we are going to compare our extract to the API malaria prevalence by RDT, which is for those between 6 and 59 months</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="va">dat</span><span class="op">$</span><span class="va">hc1</span><span class="op">&gt;</span><span class="fl">6</span> <span class="op">&amp;</span> <span class="va">dat</span><span class="op">$</span><span class="va">hc1</span><span class="op">&lt;=</span><span class="fl">60</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># create a denominator response for hml35</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">hml35denom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">hml35</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">bricks</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">hv214</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">18</span>,<span class="fl">5</span>,<span class="fl">9</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">hml20</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># specify the strata and sample weights</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">strata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">hv023</span>,<span class="va">dat</span><span class="op">$</span><span class="va">DATASET</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">hv005</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">hv005</span><span class="op">/</span><span class="fl">1e6</span></span>
<span></span>
<span><span class="co"># construct a survey design using the survey pacakge</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># construct the sample design and calculate the mean and totals </span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span><span class="op">~</span><span class="va">CLUSTER</span><span class="op">+</span><span class="va">DATASET</span>,data<span class="op">=</span><span class="va">dat</span>,weight<span class="op">=</span><span class="op">~</span><span class="va">hv005</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby</a></span><span class="op">(</span><span class="op">~</span><span class="va">hml35</span>,by<span class="op">=</span><span class="op">~</span><span class="va">DHSREGNA</span><span class="op">+</span><span class="va">DATASET</span>, <span class="va">des</span>, <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/svyciprop.html" class="external-link">svyciprop</a></span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                 <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby</a></span><span class="op">(</span><span class="op">~</span><span class="va">hml35denom</span>,by<span class="op">=</span><span class="op">~</span><span class="va">DHSREGNA</span><span class="op">+</span><span class="va">DATASET</span>, <span class="va">des</span>, <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">DATASET</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># grab the same data from the API </span></span>
<span><span class="va">dhs_api_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dhs_data.html">dhs_data</a></span><span class="op">(</span>countryIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD"</span>,<span class="st">"TZ"</span><span class="op">)</span>,indicatorIds <span class="op">=</span> <span class="st">"ML_PMAL_C_RDT"</span>,breakdown <span class="op">=</span> <span class="st">"subnational"</span>,surveyYearStart <span class="op">=</span> <span class="fl">2013</span>, surveyYearEnd <span class="op">=</span> <span class="fl">2016</span><span class="op">)</span></span>
<span><span class="va">dhs_api_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dhs_api_data</span><span class="op">$</span><span class="va">Value</span>,<span class="va">dhs_api_data</span><span class="op">$</span><span class="va">DenominatorWeighted</span>,<span class="va">dhs_api_data</span><span class="op">$</span><span class="va">CharacteristicLabel</span>, <span class="va">dhs_api_data</span><span class="op">$</span><span class="va">SurveyId</span><span class="op">)</span></span>
<span><span class="va">api</span> <span class="op">&lt;-</span> <span class="va">dhs_api_data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"\\.\\."</span>,<span class="va">dhs_api_data</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span> <span class="co"># remove subregions included in Tanzania</span></span>
<span><span class="va">api</span> <span class="op">&lt;-</span> <span class="va">api</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">api</span><span class="op">[</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,<span class="fl">1</span>,<span class="va">paste</span>,collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># bind the results and remove duplicate Region Columns</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>,<span class="va">api</span><span class="op">[</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Region"</span>,<span class="st">"Survey_RDT_Prev"</span>,<span class="st">"Survey_RDT_Denom"</span>,<span class="st">"API_RDT_Prev"</span>,<span class="st">"API_RDT_Denom"</span>,<span class="st">"API_Regions"</span>,<span class="st">"SurveyID"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                                     Region Survey_RDT_Prev API_RDT_Prev</span></span>
<span><span class="co">## Bandundu.CDPR61FL                 Bandundu       0.2038607         20.2</span></span>
<span><span class="co">## Bas-Congo.CDPR61FL               Bas-Congo       0.4761599         47.1</span></span>
<span><span class="co">## Equateur.CDPR61FL                 Equateur       0.2732268         27.4</span></span>
<span><span class="co">## Kasai-Occidental.CDPR61FL Kasai-Occidental       0.4507341         44.5</span></span>
<span><span class="co">## Kasai-Oriental.CDPR61FL     Kasai-Oriental       0.4923113         49.4</span></span>
<span><span class="co">## Katanga.CDPR61FL                   Katanga       0.3989890         38.9</span></span>
<span><span class="co">##                           Survey_RDT_Denom API_RDT_Denom  SurveyID</span></span>
<span><span class="co">## Bandundu.CDPR61FL                1415.6056          1414 CD2013DHS</span></span>
<span><span class="co">## Bas-Congo.CDPR61FL                342.6473           347 CD2013DHS</span></span>
<span><span class="co">## Equateur.CDPR61FL                1267.4746          1236 CD2013DHS</span></span>
<span><span class="co">## Kasai-Occidental.CDPR61FL         604.6050           612 CD2013DHS</span></span>
<span><span class="co">## Kasai-Oriental.CDPR61FL           892.6006           894 CD2013DHS</span></span>
<span><span class="co">## Katanga.CDPR61FL                  861.2030           844 CD2013DHS</span></span></code></pre>
<p>It’s a little off, which will be due to the specific stratification
the DHS Program will have used, as well as potentially how they have
grouped the primary sampling units. We are hoping to get this
information from the DHS for each survey so we can make this process
more streamline again.</p>
<p>And lastly we will construct a logistic regression to investigate the
relationship between a positive malaria RDT and whether the main walls
of an individual’s house were made of bricks or similar, while adjusting
for urban/rural (<code>v025</code>) and fixed effects for each
survey.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># contsruct our glm using svyglm and specify quasibinomial to handle the na in hml35</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyglm.html" class="external-link">svyglm</a></span><span class="op">(</span><span class="va">hml35</span> <span class="op">~</span> <span class="va">DATASET</span> <span class="op">+</span> <span class="va">hv025</span> <span class="op">+</span> <span class="va">net</span> <span class="op">+</span> <span class="va">bricks</span>, <span class="va">des</span>, family<span class="op">=</span><span class="st">"quasibinomial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## svyglm(formula = hml35 ~ DATASET + hv025 + net + bricks, des, </span></span>
<span><span class="co">##     family = "quasibinomial")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Survey design:</span></span>
<span><span class="co">## survey::svydesign(~CLUSTER + DATASET, data = dat, weight = ~hv005)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##                 Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)     -1.65528    0.23267  -7.114 3.20e-12 ***</span></span>
<span><span class="co">## DATASETTZPR7AFL -0.95553    0.12901  -7.406 4.39e-13 ***</span></span>
<span><span class="co">## hv025            0.52558    0.13009   4.040 6.03e-05 ***</span></span>
<span><span class="co">## netTRUE          0.06529    0.07163   0.911    0.362    </span></span>
<span><span class="co">## bricksTRUE      -0.72109    0.13517  -5.335 1.36e-07 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## (Dispersion parameter for quasibinomial family taken to be 0.9563804)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Fisher Scoring iterations: 4</span></span></code></pre>
<p>What we can see is that a significant negative gradient was
associated with walls being made of bricks or similarly good materials
in comparison to malaria positivity rates by RDT. What is also
interesting is that whether the individual slept under a long lasting
insecticidal net (<em>hml20</em> that we converted to net) was not
significant.</p>
<hr>
</div>
<div class="section level2">
<h2 id="summary-and-further-thoughts">Summary and further thoughts<a class="anchor" aria-label="anchor" href="#summary-and-further-thoughts"></a>
</h2>
<p>Hopefully the above tutorial has shown how the <code>rdhs</code>
package can facilitate both querying the DHS API and hopefully make
downloading and interacting with the raw datasets a smoother, more
reproducible process. It is worth bearing in mind though, that creating
a harmonised dataset is not always as easy as the example above - a lot
of the time survey variables differ across years and surveys, which is
hopefully when the <code>survey_questions</code> functionality will make
it easier to first filter down to those that include the relevant
questions before having to decide which survey questions are valid.</p>
<p>Any suggestions or comments/corrections/errors/ideas please let me
know either in the issues or send me an email at “<a href="mailto:o.watson15@imperial.ac.uk" class="email">o.watson15@imperial.ac.uk</a>”. And if there is any
further functionality that you think you would be useful, then also let
me know. :)</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by OJ Watson, Jeff Eaton.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
